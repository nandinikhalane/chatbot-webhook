from flask import Flask, request, jsonify

app = Flask(__name__)

# Temporary memory (in real app, use a database)
user_scores = {}

@app.route('/webhook', methods=['POST'])
def webhook():
    req = request.get_json(force=True)
    intent = req.get("queryResult").get("intent").get("displayName")

    response_text = "Sorry, I didn’t understand that."

    # ✅ Handle PHQ-9 questions
    if intent == "PHQ9_Question":
        session_id = req.get("session", "default")
        answer = req.get("queryResult").get("parameters").get("number")

        if session_id not in user_scores:
            user_scores[session_id] = []
        user_scores[session_id].append(int(answer))

        response_text = f"Got it, you answered {answer}. Let's continue."

    # ✅ Handle PHQ-9 result
    if intent == "PHQ9_Result":
        session_id = req.get("session", "default")
        scores = user_scores.get(session_id, [])
        total_score = sum(scores)

        if total_score <= 4:
            result = "Minimal depression"
        elif total_score <= 9:
            result = "Mild depression"
        elif total_score <= 14:
            result = "Moderate depression"
        elif total_score <= 19:
            result = "Moderately severe depression"
        else:
            result = "Severe depression"

        response_text = f"Your total PHQ-9 score is {total_score}, which suggests: {result}."

        user_scores[session_id] = []

    # ✅ Handle Appointment Booking
    if intent == "Book_Appointment":
        date = req.get("queryResult").get("parameters").get("date")
        time = req.get("queryResult").get("parameters").get("time")
        method = req.get("queryResult").get("parameters").get("contact_method")

        response_text = f"I booked your session on {date} at {time} via {method}."

    return jsonify({"fulfillmentText": response_text})


if __name__ == '__main__':
    app.run(host="0.0.0.0", port=5000, debug=True)
